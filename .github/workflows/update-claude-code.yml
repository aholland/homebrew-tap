name: Update claude-code formula

on:
  schedule:
    # Check every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:
    # Allow manual trigger

jobs:
  update:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout tap
        uses: actions/checkout@v4

      - name: Check for new version
        id: version
        run: |
          LATEST=$(curl -s "https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases/latest")
          CURRENT=$(grep 'version "' Casks/claude-code.rb | sed 's/.*version "\([^"]*\)".*/\1/')

          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          echo "current=$CURRENT" >> $GITHUB_OUTPUT

          if [ "$LATEST" = "$CURRENT" ]; then
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "Formula already at $CURRENT"
          else
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "Update available: $CURRENT → $LATEST"
          fi

      - name: Download and verify signature
        if: steps.version.outputs.needs_update == 'true'
        id: verify
        env:
          VERSION: ${{ steps.version.outputs.latest }}
          EXPECTED_SIGNER: "Developer ID Application: Anthropic PBC (Q6L2SF6YDW)"
        run: |
          BASE_URL="https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases/$VERSION"

          echo "Downloading darwin-arm64 binary..."
          curl -sL "$BASE_URL/darwin-arm64/claude" -o claude-arm64
          chmod +x claude-arm64

          echo "Verifying code signature..."
          AUTHORITIES=$(codesign -dvvv claude-arm64 2>&1 | grep "Authority=")

          if ! echo "$AUTHORITIES" | grep -q "$EXPECTED_SIGNER"; then
            echo "ERROR: Binary not signed by Anthropic!"
            echo "Expected: $EXPECTED_SIGNER"
            echo "Got:"
            echo "$AUTHORITIES"
            exit 1
          fi

          if ! echo "$AUTHORITIES" | grep -q "Apple Root CA"; then
            echo "ERROR: Certificate chain does not go to Apple Root CA!"
            echo "$AUTHORITIES"
            exit 1
          fi

          if ! codesign --verify --strict claude-arm64; then
            echo "ERROR: Code signature verification failed!"
            exit 1
          fi

          echo "✓ Signature verified: $EXPECTED_SIGNER"

      - name: Compute SHA256 for all platforms
        if: steps.version.outputs.needs_update == 'true'
        id: sha
        env:
          VERSION: ${{ steps.version.outputs.latest }}
        run: |
          BASE_URL="https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases/$VERSION"

          # arm64 darwin (already downloaded)
          SHA_ARM=$(shasum -a 256 claude-arm64 | cut -d' ' -f1)
          echo "arm=$SHA_ARM" >> $GITHUB_OUTPUT
          echo "  arm:          $SHA_ARM"

          # x86_64 darwin
          curl -sL "$BASE_URL/darwin-x64/claude" -o claude-x64
          SHA_X64=$(shasum -a 256 claude-x64 | cut -d' ' -f1)
          echo "x86_64=$SHA_X64" >> $GITHUB_OUTPUT
          echo "  x86_64:       $SHA_X64"

          # x86_64 linux
          curl -sL "$BASE_URL/linux-x64/claude" -o claude-linux-x64
          SHA_LINUX_X64=$(shasum -a 256 claude-linux-x64 | cut -d' ' -f1)
          echo "x86_64_linux=$SHA_LINUX_X64" >> $GITHUB_OUTPUT
          echo "  x86_64_linux: $SHA_LINUX_X64"

          # arm64 linux
          curl -sL "$BASE_URL/linux-arm64/claude" -o claude-linux-arm64
          SHA_LINUX_ARM=$(shasum -a 256 claude-linux-arm64 | cut -d' ' -f1)
          echo "arm64_linux=$SHA_LINUX_ARM" >> $GITHUB_OUTPUT
          echo "  arm64_linux:  $SHA_LINUX_ARM"

      - name: Update cask file
        if: steps.version.outputs.needs_update == 'true'
        env:
          VERSION: ${{ steps.version.outputs.latest }}
          SHA_ARM: ${{ steps.sha.outputs.arm }}
          SHA_X64: ${{ steps.sha.outputs.x86_64 }}
          SHA_LINUX_X64: ${{ steps.sha.outputs.x86_64_linux }}
          SHA_LINUX_ARM: ${{ steps.sha.outputs.arm64_linux }}
        run: |
          sed -i '' "s/version \".*\"/version \"$VERSION\"/" Casks/claude-code.rb
          sed -i '' "s/arm:          \"[a-f0-9]*\"/arm:          \"$SHA_ARM\"/" Casks/claude-code.rb
          sed -i '' "s/x86_64:       \"[a-f0-9]*\"/x86_64:       \"$SHA_X64\"/" Casks/claude-code.rb
          sed -i '' "s/x86_64_linux: \"[a-f0-9]*\"/x86_64_linux: \"$SHA_LINUX_X64\"/" Casks/claude-code.rb
          sed -i '' "s/arm64_linux:  \"[a-f0-9]*\"/arm64_linux:  \"$SHA_LINUX_ARM\"/" Casks/claude-code.rb

          echo "Updated cask to version $VERSION"
          cat Casks/claude-code.rb

      - name: Commit and push
        if: steps.version.outputs.needs_update == 'true'
        env:
          VERSION: ${{ steps.version.outputs.latest }}
          CURRENT: ${{ steps.version.outputs.current }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/claude-code.rb
          git commit -m "Update claude-code to $VERSION"
          git push

          echo "✓ Formula updated: $CURRENT → $VERSION"
